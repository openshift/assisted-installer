FROM --platform=$BUILDPLATFORM registry.access.redhat.com/ubi9/go-toolset:1.24 AS builder
ARG TARGETOS
ARG TARGETARCH

ENV COMPONENT_NAME=assisted-installer-controller
ENV COMPONENT_VERSION=1.0.0
ENV COMPONENT_TAG_EXTENSION=" "
ENV GOFLAGS="-p=4"
ENV GOEXPERIMENT=strictfipsruntime
ENV BUILD_TAGS="strictfipsruntime"

ENV USER_UID=1001 \
    USER_NAME=assisted-installer

COPY --chown=${USER_UID} . /app
WORKDIR /app

RUN GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build -tags strictfipsruntime -o assisted-installer-controller src/main/assisted-installer-controller/assisted_installer_main.go

# Metadata stage for Konflux version resolution compatibility
FROM registry.access.redhat.com/ubi9/ubi:9.4 AS rhel-metadata
RUN dnf install -y rsync && dnf clean all

# UBI9 version policy: See Dockerfile.assisted-installer for version selection rationale
FROM registry.access.redhat.com/ubi9/ubi-minimal:9.4
ARG release=main
ARG version=latest

# Copy required tools from metadata stage (packages not available in UBI9-minimal during hermetic builds)
COPY --from=rhel-metadata /usr/bin/tar /usr/bin/tar
COPY --from=rhel-metadata /usr/bin/gzip /usr/bin/gzip
COPY --from=rhel-metadata /usr/bin/rsync /usr/bin/rsync
COPY --from=rhel-metadata /usr/bin/which /usr/bin/which
COPY --from=rhel-metadata /usr/bin/find /usr/bin/find
COPY --from=rhel-metadata /usr/lib64/libpopt.so.0 /usr/lib64/libpopt.so.0
COPY --from=rhel-metadata /usr/lib64/libacl.so.1 /usr/lib64/libacl.so.1
COPY --from=rhel-metadata /usr/lib64/libattr.so.1 /usr/lib64/libattr.so.1

# Install OpenShift clients with proper architecture support
ARG TARGETARCH
RUN case "${TARGETARCH}" in \
        "") ARCH=amd64 ;; \
        *) ARCH="${TARGETARCH}" ;; \
    esac && \
    curl -L -s "https://mirror.openshift.com/pub/openshift-v4/multi/clients/ocp/latest/${ARCH}/openshift-client-linux-${ARCH}-rhel9.tar.gz" | tar xvz -C /usr/bin && \
    chmod +x /usr/bin/oc /usr/bin/kubectl

COPY LICENSE /licenses/
COPY --from=builder /app/assisted-installer-controller /assisted-installer-controller

# Copy version metadata for Konflux machine-os version resolution
COPY --from=rhel-metadata /etc/redhat-release /etc/redhat-release
COPY --from=rhel-metadata /etc/system-release-cpe /etc/system-release-cpe
COPY --from=rhel-metadata /usr/lib/os-release /usr/lib/os-release

ENTRYPOINT ["/assisted-installer-controller"]

LABEL com.redhat.component="multicluster-engine-assisted-installer-controller-container" \
      name="multicluster-engine/assisted-installer-controller-rhel9" \
      version="${version}" \
      upstream-ref="${version}" \
      upstream-url="https://github.com/openshift/assisted-installer" \
      url="https://github.com/openshift/assisted-installer" \
      summary="OpenShift Assisted Installer Controller" \
      io.k8s.display-name="OpenShift Assisted Installer Controller" \
      maintainer="Liat Gamliel <lgamliel@redhat.com>" \
      description="OpenShift Assisted Installer Controller" \
      io.k8s.description="OpenShift Assisted Installer Controller" \
      distribution-scope="public" \
      release="${release}" \
      vendor="Red Hat, Inc." \
      io.openshift.tags="OpenShift 4" \
      upstream_commit="${version}" \
      org.label-schema.vcs-ref="${version}" \
      org.label-schema.vcs-url="https://github.com/openshift/assisted-installer"
