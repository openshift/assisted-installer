FROM registry.access.redhat.com/ubi9/go-toolset:1.20.10-2 AS builder
ARG TARGETPLATFORM
ENV GOFLAGS=-mod=mod

USER root

WORKDIR /go/src/github.com/openshift/assisted-installer

# Bring in the go dependencies before anything else so we can take
# advantage of caching these layers in future builds.
COPY go.mod go.mod
COPY go.sum go.sum
RUN go mod download

COPY . .
RUN TARGETPLATFORM=$TARGETPLATFORM make controller

FROM quay.io/centos/centos:stream9

ENV OCP_VERSION=4.15-el8-beta
RUN echo -e "\
[mirror.openshift.com_pub_openshift-v4_multiarch_dependencies_rpms_${OCP_VERSION}_]\n\
name=created by dnf config-manager from https://mirror.openshift.com/pub/openshift-v4/\$basearch/dependencies/rpms/${OCP_VERSION}/\n\
baseurl=https://mirror.openshift.com/pub/openshift-v4/\$basearch/dependencies/rpms/${OCP_VERSION}/\n\
enabled=1" >  /etc/yum.repos.d/mirror.openshift.com_pub_openshift-v4_${TARGETPLATFORM}_dependencies_rpms_${OCP_VERSION}_.repo &&\
    dnf install --nogpgcheck -y openshift-clients && dnf clean all && rm -rf /var/cache

COPY --from=builder /go/src/github.com/openshift/assisted-installer/build/assisted-installer-controller /usr/bin/assisted-installer-controller

ENTRYPOINT ["/usr/bin/assisted-installer-controller"]
