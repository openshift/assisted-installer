# Install Docker tools
FROM registry.access.redhat.com/ubi9/ubi:latest@sha256:3816d303e75dec4da2d10eeb9e8651eef4393721598bea4690c607282635aa57 AS docker-tools

RUN dnf install -y 'dnf-command(config-manager)' && \
    dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo && \
    dnf install -y \
        docker-ce \
        docker-ce-cli \
        containerd.io \
        docker-compose-plugin \
    && dnf clean all

FROM registry.access.redhat.com/ubi9/go-toolset:1.25 AS golang

ENV GOFLAGS=""

RUN go install github.com/golangci/golangci-lint/cmd/golangci-lint@v1.64.7 && \
    go install golang.org/x/tools/cmd/goimports@v0.1.0 && \
    go install github.com/onsi/ginkgo/ginkgo@v1.16.1 && \
    go install go.uber.org/mock/mockgen@v0.4.0 && \
    go install gotest.tools/gotestsum@v1.6.3 && \
    go install github.com/axw/gocov/gocov@v1.1.0 && \
    go install github.com/AlekSi/gocov-xml@v1.1.0

FROM registry.access.redhat.com/ubi9/ubi-minimal:latest@sha256:6fc28bcb6776e387d7a35a2056d9d2b985dc4e26031e98a2bd35a7137cd6fd71

# Install gcc and development tools directly (brings GLIBC_2.35 symbols)
RUN microdnf install -y \
        gcc \
        gcc-c++ \
        make \
        git \
        tar \
        gzip \
        which \
        procps-ng \
        findutils \
        pkg-config \
        openssl-devel \
        glibc-devel \
    && microdnf clean all

# Copy Go environment from golang stage
COPY --from=golang /usr/lib/golang /usr/lib/golang
COPY --from=golang /opt/app-root/src/go /opt/app-root/src/go

# Copy Docker CLI tools from docker-tools stage (no daemon config needed)
COPY --from=docker-tools /usr/bin/docker /usr/bin/
COPY --from=docker-tools /usr/libexec/docker/cli-plugins/ /usr/libexec/docker/cli-plugins/

# Set Go environment variables
ENV GOROOT=/usr/lib/golang
ENV GOPATH=/opt/app-root/src/go
ENV GOMODCACHE=$GOPATH/pkg/mod
ENV GOCACHE=$GOPATH/cache
ENV PATH=$PATH:$GOROOT/bin:$GOPATH/bin
ENV LANG=en_US.UTF-8

# Create user and set proper permissions for Go directories
RUN groupadd -g 1001 app-root && \
    useradd -u 1001 -g app-root -d /opt/app-root/src app-root && \
    chmod 775 -R $GOPATH && \
    chmod 775 -R $GOROOT && \
    mkdir -p $GOMODCACHE $GOCACHE && \
    chown -R 1001:1001 /opt/app-root

# Set working directory and user to match golang base image for CI compatibility
WORKDIR /opt/app-root/src
USER 1001